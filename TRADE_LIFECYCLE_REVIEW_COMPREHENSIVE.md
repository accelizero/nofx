# åŽ†å²äº¤æ˜“è¡¨ç”Ÿå‘½å‘¨æœŸå…¨é¢ReviewæŠ¥å‘Š

## ðŸ“‹ å®¡æŸ¥èŒƒå›´

- **æž¶æž„é€»è¾‘**ï¼šç³»ç»Ÿè®¾è®¡ã€æ¨¡å—åˆ’åˆ†ã€æ•°æ®æµ
- **ä¸šåŠ¡é€»è¾‘**ï¼šä¸šåŠ¡è§„åˆ™ã€çŠ¶æ€è½¬æ¢ã€å¼‚å¸¸åœºæ™¯
- **ä»£ç é€»è¾‘**ï¼šå®žçŽ°ç»†èŠ‚ã€é”™è¯¯å¤„ç†ã€è¾¹ç•Œæƒ…å†µ
- **æ•´ä½“é€»è¾‘**ï¼šä¸€è‡´æ€§ã€å®Œæ•´æ€§ã€å¯ç»´æŠ¤æ€§

---

## 1ï¸âƒ£ æž¶æž„é€»è¾‘ Review

### âœ… ä¼˜ç‚¹

1. **æ¸…æ™°çš„æ•°æ®æ¨¡åž‹**
   - ä½¿ç”¨ `(symbol, open_time)` ä½œä¸ºå”¯ä¸€é”®ï¼Œç¬¦åˆä¸šåŠ¡è¯­ä¹‰
   - é€»è¾‘å­—æ®µåˆ†ç¦»æ¸…æ™°ï¼š`entry_logic`, `exit_logic`, `update_sl_logic`, `update_tp_logic`, `close_logic`, `forced_close_logic`

2. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
   - ä»Žå¼€ä»“åˆ°å¹³ä»“ï¼Œæ•´ä¸ªç”Ÿå‘½å‘¨æœŸç»´æŠ¤åŒä¸€ç¬”è®°å½•
   - é¿å…äº†æ•°æ®åˆ†æ•£å’Œé‡å¤

3. **åˆ†å±‚è®¾è®¡**
   - Storageå±‚ï¼š`TradeStorage` è´Ÿè´£æ•°æ®æŒä¹…åŒ–
   - Businesså±‚ï¼š`AutoTrader` è´Ÿè´£ä¸šåŠ¡é€»è¾‘
   - èŒè´£åˆ†ç¦»æ¸…æ™°

### âš ï¸ æ½œåœ¨é—®é¢˜

#### é—®é¢˜1ï¼šOpenTimeèŽ·å–çš„å¤šè·¯å¾„ä¾èµ–

**ä½ç½®**ï¼š`getOpenTimeForPosition`

**é—®é¢˜æè¿°**ï¼š
```go
// æ–¹æ³•1: ä»Žäº¤æ˜“è®°å½•æŸ¥æ‰¾
// æ–¹æ³•2: ä»ŽpositionFirstSeenTimeèŽ·å–
// æ–¹æ³•3: ä»ŽæŒä»“ä¿¡æ¯èŽ·å–ï¼ˆå®žé™…è¿”å›žé›¶å€¼ï¼‰
```

**å½±å“**ï¼š
- å¤šä¸ªæ•°æ®æºå¯èƒ½å¯¼è‡´ä¸ä¸€è‡´
- `positionFirstSeenTime` æ˜¯å†…å­˜ç¼“å­˜ï¼Œé‡å¯åŽä¸¢å¤±
- å¦‚æžœæ–¹æ³•1å¤±è´¥ï¼Œæ–¹æ³•2å¯èƒ½è¿”å›žè¿‡æ—¶æˆ–ä¸å‡†ç¡®çš„æ—¶é—´

**å»ºè®®**ï¼š
- ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ä½œä¸ºå”¯ä¸€çœŸå®žæº
- `positionFirstSeenTime` åªä½œä¸ºä¸´æ—¶ç¼“å­˜
- å¦‚æžœæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œåº”è¯¥è®°å½•é”™è¯¯è€Œä¸æ˜¯é™é»˜å¤±è´¥

#### é—®é¢˜2ï¼šæ—¶é—´åŒ¹é…çš„ç²¾åº¦é—®é¢˜

**ä½ç½®**ï¼š`GetOpenTradeByTime` ä½¿ç”¨ Â±10ç§’èŒƒå›´æŸ¥è¯¢

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆÂ±10ç§’ï¼‰æ¥é¿å…ç²¾ç¡®åŒ¹é…å¤±è´¥
- ä½†å¦‚æžœåŒä¸€å¸ç§åœ¨10ç§’å†…å¤šæ¬¡å¼€ä»“ï¼Œå¯èƒ½åŒ¹é…åˆ°é”™è¯¯çš„è®°å½•

**å½±å“**ï¼š
- æžç«¯æƒ…å†µä¸‹å¯èƒ½æ›´æ–°é”™è¯¯çš„äº¤æ˜“è®°å½•
- 10ç§’çš„çª—å£æœŸå¯èƒ½ä¸å¤Ÿï¼ˆç½‘ç»œå»¶è¿Ÿã€ç³»ç»Ÿè´Ÿè½½ï¼‰

**å»ºè®®**ï¼š
- å¢žåŠ  `side` å­—æ®µåˆ°æŸ¥è¯¢æ¡ä»¶
- å¦‚æžœæ‰¾åˆ°å¤šæ¡è®°å½•ï¼Œé€‰æ‹©æœ€æŽ¥è¿‘çš„ï¼ˆå·²å®žçŽ°ï¼‰
- è€ƒè™‘ä½¿ç”¨ `order_id` ä½œä¸ºè¾…åŠ©åŒ¹é…æ¡ä»¶

#### é—®é¢˜3ï¼šFallbackæœºåˆ¶çš„å‰¯ä½œç”¨

**ä½ç½®**ï¼š`recordTradeHistory`, `recordTradeHistoryFromPosition`

**é—®é¢˜æè¿°**ï¼š
- å¦‚æžœ `UpdateTrade` å¤±è´¥ï¼Œä¼š fallback åˆ° `LogTrade` åˆ›å»ºæ–°è®°å½•
- è¿™å¯èƒ½å¯¼è‡´åŒä¸€ç¬”äº¤æ˜“æœ‰ä¸¤æ¡è®°å½•

**å½±å“**ï¼š
- æ•°æ®é‡å¤
- ç»Ÿè®¡å’Œåˆ†æžå¯èƒ½å‡ºé”™
- è¿åäº†"æ•´ä¸ªç”Ÿå‘½å‘¨æœŸç»´æŠ¤åŒä¸€ç¬”è®°å½•"çš„è®¾è®¡åŽŸåˆ™

**å»ºè®®**ï¼š
- åœ¨ `LogTrade` å‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•ï¼ˆä½¿ç”¨ `CreateOrUpdateTrade`ï¼‰
- æˆ–è€…æ˜Žç¡®åŒºåˆ†"æ›´æ–°å¤±è´¥"å’Œ"è®°å½•ä¸å­˜åœ¨"ä¸¤ç§æƒ…å†µ

---

## 2ï¸âƒ£ ä¸šåŠ¡é€»è¾‘ Review

### âœ… ä¼˜ç‚¹

1. **é€»è¾‘å­—æ®µçš„ä¼˜å…ˆçº§è®¾è®¡**
   - ä¸»åŠ¨å¹³ä»“ï¼š`decision.Reasoning` â†’ `exit_logic` â†’ é»˜è®¤å€¼
   - å¼ºåˆ¶å¹³ä»“ï¼šä½¿ç”¨ `forced_close_logic`ï¼ˆåŒ…å«è¯¦ç»†è§¦å‘ä¿¡æ¯ï¼‰
   - é€»è¾‘æ¸…æ™°ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚

2. **å¼ºåˆ¶å¹³ä»“å’Œä¸»åŠ¨å¹³ä»“çš„äº’æ–¥**
   - `close_logic` å’Œ `forced_close_logic` äº’æ–¥
   - åœ¨ `UpdateTrade` ä¸­æ­£ç¡®å®žçŽ°

3. **æ­¢æŸæ­¢ç›ˆé€»è¾‘çš„ç´¯ç§¯**
   - æ¯æ¬¡ `update_sl`/`update_tp` éƒ½ä¼šæ›´æ–°å¯¹åº”çš„é€»è¾‘å­—æ®µ
   - ä¿ç•™äº†å®Œæ•´çš„è°ƒæ•´åŽ†å²

### âš ï¸ æ½œåœ¨é—®é¢˜

#### é—®é¢˜1ï¼šupdate_sl/tpå¤±è´¥æ—¶çš„é™é»˜å¤„ç†

**ä½ç½®**ï¼š`executeUpdateStopLoss`, `executeUpdateTakeProfit`

**é—®é¢˜æè¿°**ï¼š
```go
if err := tradeStorage.UpdateTrade(dbTrade); err != nil {
    log.Printf("  âš  æ›´æ–°äº¤æ˜“è®°å½•çš„update_sl_logicå¤±è´¥: %v", err)
    // åªè®°å½•æ—¥å¿—ï¼Œä¸å½±å“ä¸»æµç¨‹
}
```

**å½±å“**ï¼š
- å¦‚æžœè®°å½•ä¸å­˜åœ¨ï¼Œé€»è¾‘å­—æ®µä¸ä¼šæ›´æ–°
- ä½†æ­¢æŸæ­¢ç›ˆä»·æ ¼å·²ç»ä¿å­˜åˆ° `position_logic` è¡¨
- å¯¼è‡´ä¸¤ä¸ªè¡¨çš„æ•°æ®ä¸ä¸€è‡´

**å»ºè®®**ï¼š
- å¦‚æžœæ›´æ–°å¤±è´¥ï¼Œåº”è¯¥å°è¯•åˆ›å»ºè®°å½•ï¼ˆå¦‚æžœå¯èƒ½ï¼‰
- æˆ–è€…è‡³å°‘è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºŽæŽ’æŸ¥

#### é—®é¢˜2ï¼šå¼ºåˆ¶å¹³ä»“æ—¶OpenTimeèŽ·å–çš„å¯é æ€§

**ä½ç½®**ï¼š`recordTradeHistoryFromPosition`

**é—®é¢˜æè¿°**ï¼š
- å¼ºåˆ¶å¹³ä»“æ—¶ï¼Œå¯èƒ½æ— æ³•èŽ·å–å‡†ç¡®çš„ `open_time`
- å¦‚æžœ `positionFirstSeenTime` ä¸¢å¤±ï¼Œä¼šä½¿ç”¨ä¼°ç®—å€¼ï¼ˆå¹³ä»“æ—¶é—´-1å°æ—¶ï¼‰

**å½±å“**ï¼š
- ä¼°ç®—çš„ `open_time` å¯èƒ½ä¸å‡†ç¡®
- å¯èƒ½å¯¼è‡´æ— æ³•åŒ¹é…åˆ°æ­£ç¡®çš„äº¤æ˜“è®°å½•
- æœ€ç»ˆå¯èƒ½åˆ›å»ºæ–°è®°å½•è€Œä¸æ˜¯æ›´æ–°

**å»ºè®®**ï¼š
- å¼ºåˆ¶å¹³ä»“å‰ï¼Œç¡®ä¿ `open_time` å·²ä¿å­˜åˆ°æ•°æ®åº“
- å¦‚æžœæ— æ³•èŽ·å–ï¼Œåº”è¯¥è®°å½•è­¦å‘Šå¹¶å°è¯•ä»Žäº¤æ˜“æ‰€APIèŽ·å–

#### é—®é¢˜3ï¼šç³»ç»Ÿå¤–å¼€ä»“çš„å¤„ç†

**ä½ç½®**ï¼š`recordTradeHistoryFromPosition`

**é—®é¢˜æè¿°**ï¼š
- å¦‚æžœäº¤æ˜“æ˜¯åœ¨ç³»ç»Ÿå¤–å¼€ä»“çš„ï¼Œå¯èƒ½æ‰¾ä¸åˆ°å¯¹åº”çš„å¼€ä»“è®°å½•
- ä¼šåˆ›å»ºæ–°è®°å½•ï¼Œä½† `entry_logic` å’Œ `exit_logic` ä¸ºç©º

**å½±å“**ï¼š
- æ•°æ®ä¸å®Œæ•´
- æ— æ³•è¿½æº¯å¼€ä»“é€»è¾‘

**å»ºè®®**ï¼š
- æ ‡è®°ä¸º"ç³»ç»Ÿå¤–å¼€ä»“"ï¼Œåœ¨ `entry_logic` ä¸­è®°å½•
- æˆ–è€…æä¾›æ‰‹åŠ¨è¡¥å……é€»è¾‘çš„æœºåˆ¶

---

## 3ï¸âƒ£ ä»£ç é€»è¾‘ Review

### âœ… ä¼˜ç‚¹

1. **UpdateTradeçš„é”™è¯¯æ£€æŸ¥**
   - çŽ°åœ¨ä¼šæ£€æŸ¥ `RowsAffected()`ï¼Œç¡®ä¿è®°å½•å­˜åœ¨
   - å¦‚æžœè®°å½•ä¸å­˜åœ¨ï¼Œè¿”å›žæ˜Žç¡®é”™è¯¯

2. **æ—¶é—´èŒƒå›´æŸ¥è¯¢**
   - `GetOpenTradeByTime` ä½¿ç”¨æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼Œé¿å…ç²¾ç¡®åŒ¹é…å¤±è´¥
   - ä½¿ç”¨ `ORDER BY ABS(...)` é€‰æ‹©æœ€æŽ¥è¿‘çš„è®°å½•

3. **å¹¶å‘å®‰å…¨**
   - ä½¿ç”¨ `positionTimeMu` ä¿æŠ¤ `positionFirstSeenTime`
   - ä½¿ç”¨ `forcedCloseMu` ä¿æŠ¤ `forcedClosedPositions`

### âš ï¸ æ½œåœ¨é—®é¢˜

#### é—®é¢˜1ï¼šUpdateTradeçš„SQLæ³¨å…¥é£Žé™©ï¼ˆå·²ç¼“è§£ï¼‰

**ä½ç½®**ï¼š`UpdateTrade`

**é—®é¢˜æè¿°**ï¼š
```go
query := fmt.Sprintf(
    "UPDATE trades SET %s WHERE symbol = ? AND open_time = ?",
    strings.Join(updates, ", "),
)
```

**åˆ†æž**ï¼š
- è™½ç„¶ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢ï¼Œä½†å­—æ®µåæ˜¯é€šè¿‡å­—ç¬¦ä¸²æ‹¼æŽ¥çš„
- å¦‚æžœ `updates` ä¸­åŒ…å«ç”¨æˆ·è¾“å…¥ï¼Œå¯èƒ½æœ‰é£Žé™©

**çŽ°çŠ¶**ï¼š
- å½“å‰å®žçŽ°ä¸­ï¼Œ`updates` éƒ½æ˜¯ç¡¬ç¼–ç çš„å­—æ®µåï¼Œé£Žé™©è¾ƒä½Ž
- ä½†ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§å¯ä»¥æ”¹è¿›

**å»ºè®®**ï¼š
- ä½¿ç”¨ç™½åå•éªŒè¯å­—æ®µå
- æˆ–è€…ä½¿ç”¨ORM/æŸ¥è¯¢æž„å»ºå™¨

#### é—®é¢˜2ï¼šgetOpenTimeForPositionçš„æŸ¥æ‰¾é¡ºåº

**ä½ç½®**ï¼š`getOpenTimeForPosition`

**é—®é¢˜æè¿°**ï¼š
```go
// æ–¹æ³•1: ä»Žäº¤æ˜“è®°å½•æŸ¥æ‰¾ï¼ˆä¼˜å…ˆï¼‰
// æ–¹æ³•2: ä»ŽpositionFirstSeenTimeèŽ·å–
// æ–¹æ³•3: ä»ŽæŒä»“ä¿¡æ¯èŽ·å–ï¼ˆè¿”å›žé›¶å€¼ï¼‰
```

**é—®é¢˜**ï¼š
- æ–¹æ³•2ï¼ˆå†…å­˜ç¼“å­˜ï¼‰å¯èƒ½åœ¨æ–¹æ³•1ï¼ˆæ•°æ®åº“ï¼‰ä¹‹å‰è¿”å›ž
- å¦‚æžœæ•°æ®åº“æŸ¥è¯¢æ…¢ï¼Œå¯èƒ½ä½¿ç”¨è¿‡æ—¶çš„ç¼“å­˜æ•°æ®

**å»ºè®®**ï¼š
- ç¡®ä¿æ–¹æ³•1ä¼˜å…ˆï¼Œæ–¹æ³•2åªä½œä¸ºfallback
- å¦‚æžœæ–¹æ³•1å¤±è´¥ï¼Œåº”è¯¥ç­‰å¾…æˆ–é‡è¯•ï¼Œè€Œä¸æ˜¯ç«‹å³ä½¿ç”¨ç¼“å­˜

#### é—®é¢˜3ï¼šrecordTradeHistoryçš„å¤æ‚é€»è¾‘

**ä½ç½®**ï¼š`recordTradeHistory`

**é—®é¢˜æè¿°**ï¼š
- å‡½æ•°é€»è¾‘å¤æ‚ï¼ŒåŒ…å«å¤šå±‚åµŒå¥—
- éœ€è¦ä»Žå†³ç­–è®°å½•ä¸­æŸ¥æ‰¾å¼€ä»“è®°å½•ï¼Œå¹¶å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ

**å½±å“**ï¼š
- ä»£ç å¯è¯»æ€§å·®
- éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤
- å®¹æ˜“å‡ºçŽ°é€»è¾‘é”™è¯¯

**å»ºè®®**ï¼š
- æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°
- ä½¿ç”¨æ›´æ¸…æ™°çš„æ•°æ®ç»“æž„
- å¢žåŠ å•å…ƒæµ‹è¯•

---

## 4ï¸âƒ£ æ•´ä½“é€»è¾‘ Review

### âœ… ä¼˜ç‚¹

1. **æ•°æ®ä¸€è‡´æ€§**
   - ä½¿ç”¨å”¯ä¸€é”®çº¦æŸç¡®ä¿ä¸ä¼šé‡å¤åˆ›å»º
   - æ•´ä¸ªç”Ÿå‘½å‘¨æœŸç»´æŠ¤åŒä¸€ç¬”è®°å½•

2. **é”™è¯¯æ¢å¤**
   - å¦‚æžœæ›´æ–°å¤±è´¥ï¼Œä¼šåˆ›å»ºæ–°è®°å½•ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
   - æœ‰fallbackæœºåˆ¶

3. **å‘åŽå…¼å®¹**
   - ä¿ç•™äº† `LogTrade` æ–¹æ³•
   - æ”¯æŒæ—§æ•°æ®çš„è¿ç§»

### âš ï¸ æ½œåœ¨é—®é¢˜

#### é—®é¢˜1ï¼šæ•°æ®ä¸€è‡´æ€§çš„è¾¹ç•Œæƒ…å†µ

**åœºæ™¯**ï¼š
1. å¼€ä»“æ—¶åˆ›å»ºè®°å½•æˆåŠŸ
2. æ›´æ–°æ­¢æŸæ—¶ï¼Œè®°å½•è¢«æ„å¤–åˆ é™¤
3. å¹³ä»“æ—¶ï¼Œ`UpdateTrade` å¤±è´¥ï¼Œfallback åˆ° `LogTrade`
4. ç»“æžœï¼šåŒä¸€ç¬”äº¤æ˜“æœ‰ä¸¤æ¡è®°å½•

**å½±å“**ï¼š
- æ•°æ®é‡å¤
- ç»Ÿè®¡é”™è¯¯

**å»ºè®®**ï¼š
- åœ¨ `LogTrade` å‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•
- ä½¿ç”¨ `CreateOrUpdateTrade` è€Œä¸æ˜¯ç›´æŽ¥ `LogTrade`

#### é—®é¢˜2ï¼šæ—¶é—´ç²¾åº¦çš„ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š
- äº¤æ˜“æ‰€APIè¿”å›žçš„æ—¶é—´æˆ³ç²¾åº¦å¯èƒ½ä¸åŒï¼ˆç§’/æ¯«ç§’ï¼‰
- æ•°æ®åº“å­˜å‚¨çš„æ—¶é—´ç²¾åº¦
- ç³»ç»Ÿæ—¶é—´ç²¾åº¦

**å½±å“**ï¼š
- æ—¶é—´åŒ¹é…å¯èƒ½å¤±è´¥
- å³ä½¿ä½¿ç”¨èŒƒå›´æŸ¥è¯¢ï¼Œä¹Ÿå¯èƒ½åŒ¹é…åˆ°é”™è¯¯çš„è®°å½•

**å»ºè®®**ï¼š
- ç»Ÿä¸€æ—¶é—´ç²¾åº¦ï¼ˆå»ºè®®ä½¿ç”¨æ¯«ç§’ï¼‰
- åœ¨å­˜å‚¨å‰æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼
- å¢žåŠ  `order_id` ä½œä¸ºè¾…åŠ©åŒ¹é…æ¡ä»¶

#### é—®é¢˜3ï¼šå¹¶å‘æ›´æ–°çš„ç«žäº‰æ¡ä»¶

**åœºæ™¯**ï¼š
1. çº¿ç¨‹Aï¼šæ›´æ–°æ­¢æŸé€»è¾‘
2. çº¿ç¨‹Bï¼šæ›´æ–°æ­¢ç›ˆé€»è¾‘
3. çº¿ç¨‹Cï¼šå¹³ä»“æ›´æ–°

**é—®é¢˜**ï¼š
- å¦‚æžœä¸‰ä¸ªæ“ä½œå‡ ä¹ŽåŒæ—¶å‘ç”Ÿï¼Œå¯èƒ½è¦†ç›–å½¼æ­¤çš„æ›´æ–°
- SQLiteçš„å¹¶å‘å†™å…¥æ€§èƒ½æœ‰é™

**å½±å“**ï¼š
- æ•°æ®ä¸¢å¤±æˆ–ä¸ä¸€è‡´

**å»ºè®®**ï¼š
- ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŽŸå­æ€§
- æˆ–è€…ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰
- è€ƒè™‘ä½¿ç”¨æ›´å¼ºå¤§çš„æ•°æ®åº“ï¼ˆå¦‚PostgreSQLï¼‰

---

## ðŸ“Š é—®é¢˜ä¼˜å…ˆçº§æ€»ç»“

### ðŸ”´ é«˜ä¼˜å…ˆçº§

1. **Fallbackæœºåˆ¶å¯¼è‡´æ•°æ®é‡å¤**
   - å½±å“ï¼šæ•°æ®ä¸€è‡´æ€§
   - å»ºè®®ï¼šåœ¨ `LogTrade` å‰æ£€æŸ¥è®°å½•æ˜¯å¦å­˜åœ¨

2. **æ—¶é—´åŒ¹é…çš„ç²¾åº¦é—®é¢˜**
   - å½±å“ï¼šå¯èƒ½æ›´æ–°é”™è¯¯çš„è®°å½•
   - å»ºè®®ï¼šå¢žåŠ  `side` å­—æ®µåˆ°æŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨ `order_id` è¾…åŠ©åŒ¹é…

3. **å¹¶å‘æ›´æ–°çš„ç«žäº‰æ¡ä»¶**
   - å½±å“ï¼šæ•°æ®ä¸¢å¤±
   - å»ºè®®ï¼šä½¿ç”¨äº‹åŠ¡æˆ–ä¹è§‚é”

### ðŸŸ¡ ä¸­ä¼˜å…ˆçº§

4. **OpenTimeèŽ·å–çš„å¤šè·¯å¾„ä¾èµ–**
   - å½±å“ï¼šæ•°æ®ä¸ä¸€è‡´
   - å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ï¼Œç¼“å­˜åªä½œä¸ºä¸´æ—¶fallback

5. **update_sl/tpå¤±è´¥æ—¶çš„é™é»˜å¤„ç†**
   - å½±å“ï¼šæ•°æ®ä¸å®Œæ•´
   - å»ºè®®ï¼šå°è¯•åˆ›å»ºè®°å½•æˆ–è®°å½•è¯¦ç»†é”™è¯¯

6. **å¼ºåˆ¶å¹³ä»“æ—¶OpenTimeèŽ·å–çš„å¯é æ€§**
   - å½±å“ï¼šå¯èƒ½æ— æ³•åŒ¹é…è®°å½•
   - å»ºè®®ï¼šç¡®ä¿ `open_time` å·²ä¿å­˜åˆ°æ•°æ®åº“

### ðŸŸ¢ ä½Žä¼˜å…ˆçº§

7. **recordTradeHistoryçš„å¤æ‚é€»è¾‘**
   - å½±å“ï¼šå¯ç»´æŠ¤æ€§
   - å»ºè®®ï¼šé‡æž„ä¸ºå¤šä¸ªå°å‡½æ•°

8. **ç³»ç»Ÿå¤–å¼€ä»“çš„å¤„ç†**
   - å½±å“ï¼šæ•°æ®å®Œæ•´æ€§
   - å»ºè®®ï¼šæ ‡è®°ä¸º"ç³»ç»Ÿå¤–å¼€ä»“"

---

## ðŸŽ¯ æ”¹è¿›å»ºè®®

### çŸ­æœŸæ”¹è¿›ï¼ˆ1-2å‘¨ï¼‰

1. **ä¿®å¤Fallbackæœºåˆ¶**
   ```go
   // åœ¨ LogTrade å‰æ£€æŸ¥
   existing, _ := tradeStorage.GetOpenTradeByTime(symbol, openTime)
   if existing != nil {
       // å°è¯•æ›´æ–°è€Œä¸æ˜¯åˆ›å»º
       return tradeStorage.UpdateTrade(dbTrade)
   }
   ```

2. **å¢žå¼ºæ—¶é—´åŒ¹é…**
   ```go
   // å¢žåŠ  side å­—æ®µåˆ°æŸ¥è¯¢
   query := `
       SELECT * FROM trades
       WHERE symbol = ? AND side = ? AND open_time >= ? AND open_time <= ?
       ORDER BY ABS((julianday(open_time) - julianday(?)) * 86400) ASC
       LIMIT 1
   `
   ```

3. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - åŒºåˆ†"è®°å½•ä¸å­˜åœ¨"å’Œ"æ›´æ–°å¤±è´¥"
   - è®°å½•æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

### ä¸­æœŸæ”¹è¿›ï¼ˆ1-2æœˆï¼‰

4. **é‡æž„recordTradeHistory**
   - æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°
   - å¢žåŠ å•å…ƒæµ‹è¯•

5. **ç»Ÿä¸€æ—¶é—´å¤„ç†**
   - åˆ›å»ºæ—¶é—´å·¥å…·å‡½æ•°
   - ç»Ÿä¸€æ—¶é—´ç²¾åº¦å’Œæ ¼å¼

6. **å¢žåŠ äº‹åŠ¡æ”¯æŒ**
   - ä½¿ç”¨äº‹åŠ¡ç¡®ä¿åŽŸå­æ€§
   - å¤„ç†å¹¶å‘æ›´æ–°

### é•¿æœŸæ”¹è¿›ï¼ˆ3-6æœˆï¼‰

7. **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**
   - å®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§
   - ä¿®å¤ä¸ä¸€è‡´çš„è®°å½•

8. **æ€§èƒ½ä¼˜åŒ–**
   - ç´¢å¼•ä¼˜åŒ–
   - æŸ¥è¯¢ä¼˜åŒ–
   - è€ƒè™‘ä½¿ç”¨æ›´å¼ºå¤§çš„æ•°æ®åº“

---

## ðŸ“ æ€»ç»“

### æ•´ä½“è¯„ä»·

**ä¼˜ç‚¹**ï¼š
- âœ… æž¶æž„è®¾è®¡æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»æ˜Žç¡®
- âœ… ä¸šåŠ¡é€»è¾‘ç¬¦åˆéœ€æ±‚ï¼Œä¼˜å…ˆçº§è®¾è®¡åˆç†
- âœ… æœ‰é”™è¯¯æ¢å¤æœºåˆ¶ï¼Œå‘åŽå…¼å®¹

**éœ€è¦æ”¹è¿›**ï¼š
- âš ï¸ æ•°æ®ä¸€è‡´æ€§çš„è¾¹ç•Œæƒ…å†µå¤„ç†
- âš ï¸ æ—¶é—´åŒ¹é…çš„ç²¾åº¦å’Œå¯é æ€§
- âš ï¸ å¹¶å‘æ›´æ–°çš„ç«žäº‰æ¡ä»¶
- âš ï¸ ä»£ç å¤æ‚åº¦å’Œå¯ç»´æŠ¤æ€§

### å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤**ï¼šFallbackæœºåˆ¶å¯¼è‡´çš„æ•°æ®é‡å¤é—®é¢˜
2. **çŸ­æœŸæ”¹è¿›**ï¼šæ—¶é—´åŒ¹é…çš„ç²¾åº¦å’Œå¹¶å‘æ›´æ–°
3. **ä¸­æœŸé‡æž„**ï¼šä»£ç å¤æ‚åº¦å’Œé”™è¯¯å¤„ç†
4. **é•¿æœŸä¼˜åŒ–**ï¼šæ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

---

## ðŸ” ä»£ç å®¡æŸ¥æ¸…å•

- [ ] æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æœ‰é”™è¯¯å¤„ç†
- [ ] æ—¶é—´åŒ¹é…è€ƒè™‘äº†ç²¾åº¦é—®é¢˜
- [ ] å¹¶å‘æ›´æ–°æœ‰ä¿æŠ¤æœºåˆ¶
- [ ] Fallbackæœºåˆ¶ä¸ä¼šå¯¼è‡´æ•°æ®é‡å¤
- [ ] OpenTimeèŽ·å–æœ‰å¯é çš„fallback
- [ ] å¼ºåˆ¶å¹³ä»“å’Œä¸»åŠ¨å¹³ä»“é€»è¾‘äº’æ–¥
- [ ] ç³»ç»Ÿå¤–å¼€ä»“æœ‰æ˜Žç¡®æ ‡è®°
- [ ] æ—¥å¿—è®°å½•è¶³å¤Ÿè¯¦ç»†ï¼Œä¾¿äºŽæŽ’æŸ¥é—®é¢˜

